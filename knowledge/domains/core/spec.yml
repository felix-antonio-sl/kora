# KODA/Spec Specification v1.0
# Core format specification for RAG-optimized knowledge artifacts
# Foundation layer of the knowledge engineering stack

_manifest:
  urn: "urn:knowledge:koda:core:spec:1.0.0"
  federation:
    visibility: public
    license: "CC-BY-4.0"
  compatibility:
    min_consumer_version: "1.0.0"
    breaking_changes_from: null
  resolution:
    canonical_url: "file://knowledge/core/guide_core_001_koda-spec_koda.yml"
    mirrors: []
  dependencies:
    requires: [] # Root artifact - no dependencies
  provenance:
    created_by: "FS"
    created_at: "2025-11-21"
    last_modified_by: "FS"
    last_modified_at: "2026-01-29"
    signature: null

ID: KODA-SPEC-01
Version: 1.1.0
Status: Published
Human-Creator: FS
Human-Editor: FS
Model-Collaborator: IA-CLAUDE
Creation-Date: 2025-11-21
Modification-Date: 2026-01-29
Version-Notes: "v1.1.0 - Added XRef/XRef_Required keywords for cross-artifact referencing, consolidated Cross_Artifact_Referencing section, anti-cycle validation rule"
Source: GUIDE-KODA-MASTER-01
Ctx: Technical specification of KODA as YAML extension

LLM_Parsing_Instructions:
  ID: KODA-LLM-PARSER-01
  Req: Mandatory block following Metadata.
  Prohib: Using for artifact creation or translation.
  Content: |
    BEGIN_LLM_INSTRUCTIONS
    You are an AI agent consuming a KODA artifact. Parse with absolute fidelity.

    FIDELITY: Preserve meat (essential information) and skeleton (structure: headers, IDs, lists, tables) with zero loss. Ignore fat (filler words, rhetoric, stylistic prose).

    LEXICON (expand before processing): Act->Action, Cond->Condition, Ctx->Context, Ctx_Required->Required External Reference, Ctx_Optional->Optional External Reference, Def->Definition, Ex->Example, Mssn->Mission, Obj->Objective, Proc->Process, Purp->Purpose, Ref->Reference, XRef->Cross-Artifact Reference, XRef_Required->Mandatory Cross-Artifact Reference, Req->Requirement, Res->Result, Src->Source, Prohib->Prohibition, Warn->Warning, Just->Justification, Rec->Recommendation

    REFERENCE POLICY: Ref: is internal only—must point to existing ID within THIS document. XRef/XRef_Required: are external only—must point to a URN (optionally with #ID fragment) in another artifact. External documents without specific ID use Ctx:, Ctx_Required:, or Ctx_Optional:.

    LANGUAGE POLICY: Keywords in English, content in original language. Never translate content.
    END_LLM_INSTRUCTIONS

Purp: Define KODA/Spec ( Specification) as formal extension of YAML for RAG-optimized knowledge artifacts.

# 1. Definition

KODA:
  Def: YAML-compliant format using controlled keyword vocabulary for semantic markup.
  Obj: Transform verbose human documents into dense, structured artifacts for LLM consumption via RAG.
  Key_Characteristics:
    - Zero information loss (absolute fidelity)
    - Telegraphic brevity (maximum token density)
    - Structural semantics (hierarchy, tables, lists carry meaning)
    - Internal referencing (eliminate redundancy)

# 2. YAML Extension Mechanism

Extension_Model:
  Base: YAML 1.2 specification
  Constraint: All KODA documents must be valid YAML
  Extension: KODA keywords used as YAML keys for semantic markup

Schema:
  Pattern: "Keyword: ContentValue"
  Example: '"Def: A definition" or "Risk_Factors: High blood pressure"'
  Validation: Keys must be either Tier 1 (Core) or Tier 2 (Semantic).

# 3. Keyword Strategy (Tiered Lexicon)

Keyword_Strategy:
  ID: KODA-KEYWORD-STRATEGY-01
  Def: Dual-tier system combining rigid structural control with flexible semantic expression.
  Obj: Maximize token economy and RAG retrieval quality by using semantically dense keys.

  Tier_1_Core_Structural:
    Def: Reserved keywords for logical structure, referencing, and execution.
    Req: MUST be used for their specific purpose. DO NOT invent alternatives for these functions.
    Keywords:
      - Keyword: ID
        Def: Unique Identifier (Immutable).
      - Keyword: Ref
        Def: Internal cross-reference to another ID within the same artifact.
      - Keyword: XRef
        Def: Cross-artifact reference to another KODA artifact, optionally to a specific ID via fragment.
      - Keyword: XRef_Required
        Def: Mandatory cross-artifact reference that MUST resolve for the consumer to proceed.
      - Keyword: Def
        Def: Definition of a term or concept.
      - Keyword: Act
        Def: Action or instruction to be executed.
      - Keyword: Cond
        Def: Condition or logic gate (If/Else).
      - Keyword: Res
        Def: Result, outcome, or implication.
      - Keyword: Req
        Def: Requirement or mandatory constraint.
      - Keyword: Ctx
        Def: Context, scope, or background information (generic).
      - Keyword: Ctx_Required
        Def: External reference that MUST be consulted (mandatory dependency).
      - Keyword: Ctx_Optional
        Def: External reference for additional context (informational, non-blocking).
      - Keyword: Ex
        Def: Example or illustration.
      - Keyword: Purp
        Def: Purpose or reason for existence.
      - Keyword: Mssn
        Def: Mission or overarching goal.
      - Keyword: Obj
        Def: Specific objective.
      - Keyword: Proc
        Def: Process or workflow.
      - Keyword: Src
        Def: Source or origin.
      - Keyword: Prohib
        Def: Prohibition or restriction.
      - Keyword: Warn
        Def: Warning or critical alert.
      - Keyword: Just
        Def: Justification or rationale.
      - Keyword: Rec
        Def: Recommendation (non-mandatory).

  Tier_2_Semantic_Domain:
    Def: Open vocabulary for domain-specific containers, attributes, and classifications.
    Req:
      - Must be self-explanatory in the document's language (English/Spanish).
      - Must be concise (Snake_Case or CamelCase).
      - Must NOT duplicate Tier 1 functionality (e.g., do not use 'Definition' if 'Def' applies).
    Best_Practices:
      - "Use specific terms: 'Symptoms' is better than 'Ctx: Type: Symptoms'."
      - "Use natural anchors: 'Tacticas', 'Riesgos', 'Escenarios' act as strong attention anchors."
    Examples:
      - Valid: '"Tacticas_Universales", "Risk_Factors", "Clinical_Signs", "Pregunta_Clave"'
      - Invalid: '"Definition_Formal" (Use Def), "Action_Item" (Use Act), "Item_1" (Use list)'

# 4. Mandatory Document Structure

Metadata_Block:
  ID: KODA-STRUCT-METADATA
  Purp: Identify document version, authorship, and lifecycle.
  Req: Must be first element in every KODA artifact.

  Required_Fields:
    - Field: Version
      Def: Semantic versioning (MAJOR.MINOR.PATCH)

    - Field: Status
      Def: Lifecycle state
      Values: [Draft, Review, Published, Obsolete]

    - Field: Human-Creator
      Def: Original human author (name or initials)

    - Field: Human-Editor
      Def: Last human editor (name or initials)

    - Field: Model-Collaborator
      Def: LLM that participated in creation/editing

    - Field: Creation-Date
      Format: YYYY-MM-DD

    - Field: Modification-Date
      Format: YYYY-MM-DD

    - Field: Ctx
      Def: Document scope or contextual category

Spec_LLM_Parsing_Instructions:
  ID: KODA-STRUCT-INSTRUCTIONS
  Purp: Provide rules for LLM consumption with perfect fidelity.
  Req: Mandatory block immediately following Metadata Block.
  Prohib: Using these instructions for creation/translation tasks.
  Content_Structure:
    - Section: Core Objective (Fidelity)
    - Section: Conceptual Metaphors (Meat vs Fat)
    - Section: Lexicon Mode (Expansion rules)
    - Section: Reference Policy (Internal only)
    - Section: Language Invariance Policy

  Standard_Template: |
    LLM_Parsing_Instructions:
      ID: KODA-LLM-PARSER-01
      Req: Mandatory block following Metadata.
      Prohib: Using for artifact creation or translation.
      Content: |
        BEGIN_LLM_INSTRUCTIONS
        You are an AI agent consuming a KODA artifact. Parse with absolute fidelity.

        FIDELITY: Preserve meat (essential information) and skeleton (structure: headers, IDs, lists, tables) with zero loss. Ignore fat (filler words, rhetoric, stylistic prose).

        LEXICON (expand before processing): Act->Action, Cond->Condition, Ctx->Context, Ctx_Required->Required External Reference, Ctx_Optional->Optional External Reference, Def->Definition, Ex->Example, Mssn->Mission, Obj->Objective, Proc->Process, Purp->Purpose, Ref->Reference, XRef->Cross-Artifact Reference, XRef_Required->Mandatory Cross-Artifact Reference, Req->Requirement, Res->Result, Src->Source, Prohib->Prohibition, Warn->Warning, Just->Justification, Rec->Recommendation

        REFERENCE POLICY: Ref: is internal only—must point to existing ID within THIS document. XRef/XRef_Required: are external only—must point to a URN (optionally with #ID fragment) in another artifact. External documents without specific ID use Ctx:, Ctx_Required:, or Ctx_Optional:.

        LANGUAGE POLICY: Keywords in English, content in original language. Never translate content.
        END_LLM_INSTRUCTIONS

# 5. Structural Semantics

Structure_Principles:
  ID: KODA-PRINCIPLE-STRUCTURE
  Def: Structural elements (hierarchy, unique identifiers, cross-references, table relationships, list ordering) are informational meat, not presentation.
  Req: Preserve all structural relationships as they carry semantic meaning.

  Elements:
    - Element: Hierarchy
      Def: Nested YAML structure represents logical containment and importance.
      Req: Maintain nesting depth to preserve relationships.

    - Element: Unique_Identifiers
      Keyword: ID
      Def: Anchor points for internal references.
      Req: Globally unique within artifact.
      Format: UPPERCASE-KEBAB-CASE with semantic naming.
      Ex: GUIDE-KODA-PRINCIPLE-FIDELITY-01

    - Element: Cross_References
      Keyword: Ref
      Def: Eliminate redundancy by pointing to single definition within the same artifact.
      Req: Target must exist within same artifact.
      Prohib: External document references (use XRef/XRef_Required for other artifacts).

    - Element: Cross_Artifact_References
      Keyword: XRef / XRef_Required
      Def: Link semantically related content across different artifacts using URN with optional #ID fragment.
      Req: URN must be valid and resolvable via catalog/resolver chain.
      Prohib: Using XRef or XRef_Required to reference the current artifact (use Ref instead).

# 5.1 Cross-Artifact Referencing (Detailed)

Cross_Artifact_Referencing:
  ID: KODA-CROSS-REF-01
  Purp: Enable semantic linking between KODA artifacts to form knowledge graphs.

  Keywords:
    XRef:
      Def: Soft reference to another artifact or specific ID within it.
      Semantics: Informational link; resolution is best-effort.
      Use_When: Linking related content that can degrade gracefully if unavailable.

    XRef_Required:
      Def: Hard reference that MUST resolve for artifact to be valid.
      Semantics: Blocking dependency; consumer cannot proceed if unresolved.
      Use_When: Structural dependencies where the referenced content is essential.

  Format:
    Pattern: "urn:knowledge:{namespace}:{domain}:{artifact}:{version}[#{ID}]"
    Components:
      - namespace: Organization publishing the artifact (e.g., koda, orko, fxsl)
      - domain: Thematic domain (e.g., core, metodologia, agents)
      - artifact: Artifact identifier in kebab-case
      - version: Semantic version (1.0.0) or keyword (latest, stable)
      - fragment: Optional #ID pointing to specific block within artifact
    Examples:
      - Full_Artifact: "urn:knowledge:koda:core:spec:1.0.0"
      - With_Fragment: "urn:knowledge:koda:core:orko-fundamentos:1.0.0#ORKO-AX-A1"
      - Required_Fragment: "urn:knowledge:koda:core:orko-tejidos:1.0.0#ORKO-TF1-DEF"
    Validation_Pattern: "^urn:knowledge:[a-z][a-z0-9-]*:[a-z][a-z0-9_-]*:[a-z][a-z0-9-]+:(\\d+\\.\\d+\\.\\d+|latest|stable)(#[A-Z][A-Z0-9-]+)?$"

  Resolution_Chain:
    Steps:
      - "1. Parse URN and extract optional fragment"
      - "2. Resolve namespace via .knowledge-resolver.yml"
      - "3. Query catalog for artifact file path"
      - "4. If fragment present, parse target YAML and locate ID"
      - "5. Return content (full artifact or specific block)"
    Cognitive_Model: "CM-XREF-RESOLVER (defined in KODA/Hub)"

  Graph_Properties:
    Acyclicity:
      Def: XRef_Required edges must form a DAG (no cycles).
      Rationale: Prevents infinite resolution loops.
    Compositionality:
      Def: Artifacts can be composed by following XRef chains.
      Rationale: Enables modular knowledge construction.
    Traceability:
      Forward: From A, follow XRef to discover dependencies.
      Inverse: From B, check catalog Referenced_By to find consumers.

  Best_Practices:
    - "Use XRef for informational links that can degrade gracefully"
    - "Use XRef_Required for structural dependencies"
    - "Prefer fragment references (#ID) for precision"
    - "Register stable IDs in catalog Exported_IDs"
    - "Pin explicit versions; avoid 'latest' with fragments"
    - "Check Referenced_By before modifying exported IDs"

  Comparison_With_Other_Keywords:
    Table: |
      | Keyword        | Scope    | Resolution | Blocking | Use Case                          |
      |----------------|----------|------------|----------|-----------------------------------|
      | Ref            | Internal | ID lookup  | N/A      | Deduplication within artifact     |
      | Ctx            | External | None       | No       | Informational mention             |
      | Ctx_Required   | External | None       | Semantic | Conceptual dependency (no URN)    |
      | XRef           | External | URN+frag   | No       | Cross-artifact navigation         |
      | XRef_Required  | External | URN+frag   | Yes      | Cross-artifact hard dependency    |

# 5.2 Tables and Lists (Structural Elements)

Tables_And_Lists:
  ID: KODA-TABLES-LISTS-01
  Purp: Preserve structural semantics of tabular and sequential data.

  Tables:
    Def: Tabular structures preserve multi-dimensional relationships between data points.
    Req: Maintain complete table structure including all rows, columns, and cell relationships.
    Prohib: Converting table to another format or flattening relational data.

  Lists:
    Def: List structures preserve sequence semantics.
    Types:
      - Ordered: Sequence matters (YAML list with implicit order)
      - Unordered: Grouping only (sequence arbitrary)
    Req: Maintain list type and item ordering as they carry semantic meaning.

# 6. Core Principles

Principles:
  - Principle: Absolute Fidelity
    ID: KODA-PRINCIPLE-FIDELITY
    Def: Zero loss of informational meat during transformation.
    Req: All original data points must be preserved.
    Prohib: Summarization or inference.

  - Principle: Single Source of Truth
    ID: KODA-PRINCIPLE-SSOT
    Def: Each concept defined once with unique ID, referenced elsewhere via Ref.
    Req: Use Ref for all repetitions.
    Res: Eliminates redundancy and ensures consistency.

  - Principle: Maximum Density
    ID: KODA-PRINCIPLE-DENSITY
    Def: Maximum informational meat per token.
    Mech: Telegraphic brevity, keyword-based markup, reference-based deduplication.
    Target: CR > 1.0 (artifact smaller than source in characters)

  - Principle: Token Economy (LLM-First Design)
    ID: KODA-PRINCIPLE-TOKEN-ECONOMY
    Def: KODA artifacts are for LLM consumption, NOT human readability.
    Req:
      - Eliminate explanatory verbosity
      - Use lexicon abbreviations aggressively
      - No duplication (use Ref/XRef)
      - Prefer telegraphic structures over prose
    Target: CR > 1.0 (artifact smaller than source in characters)
    Prohib: Human-oriented explanations, redundancy, narrative prose.

  - Principle: Structural Semantics
    Ref: KODA-PRINCIPLE-STRUCTURE

  - Principle: Language Invariance
    ID: KODA-PRINCIPLE-LANGUAGE
    Def: Keywords in English, content in original language.
    Req: Never translate content during KODA transformation.
    Just: Preserves fidelity and allows multilingual artifacts.

# 7. Validation Schema

Validation:
  ID: KODA-VALIDATION-01
  Purp: Criteria for valid KODA artifact.

  Syntax_Validation:
    - Rule: Valid YAML
      Test: Must parse without errors using YAML 1.2 parser.

    - Rule: Keywords from lexicon
      Test: All keys match official KODA keywords.

    - Rule: Unique IDs
      Test: No duplicate ID values within artifact.

    - Rule: Valid references
      Test: All Ref values point to existing ID within artifact.

    - Rule: Valid XRef format
      Test: All XRef and XRef_Required values match URN pattern with optional #fragment.

    - Rule: XRef not self-referential
      Test: XRef and XRef_Required URNs do not reference the artifact's own URN.

  Semantic_Validation:
    - Rule: Metadata block present
      Test: First element contains required fields.

    - Rule: No information loss
      Test: Manual verification that all source data preserved.

    - Rule: No redundancy
      Test: Concepts defined once, referenced via Ref elsewhere.

    - Rule: Compression efficiency
      Test: "Artifact uses fewer characters than source (CR > 1.0)."

    - Rule: XRef resolvable
      Test: All XRef and XRef_Required URNs resolve via catalog/resolver chain.

    - Rule: Fragment exists in target (best-effort)
      Test: If XRef or XRef_Required contains #fragment, ID exists in target artifact; failing this SHOULD raise a warning.

    - Rule: No circular XRef_Required dependencies
      Test: Dependency graph formed by XRef_Required edges is acyclic (DAG).
      Algorithm: Topological sort; if fails, report cycle path.
      Severity: error
